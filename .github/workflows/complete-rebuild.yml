name: 🚀 ABC English Explorer - Complete Rebuild

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean repository completely
        run: |
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          rm -rf assets lessons css js components || true

      - name: Build main site and resources
        run: |
          mkdir -p assets/images assets/icons assets/sounds lessons/grade1

          cat > index.html <<EOF
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🤖 ABC English Explorer v3.0</title>
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <div style="text-align:center;padding:2em;">
    <div style="font-size:5em;">🤖</div>
    <h1>ABC English Explorer v3.0</h1>
    <h2>ברוכים הבאים לפלטפורמה חינוכית מתקדמת</h2>
    <p>התחילו ללמוד עם 5 שיעורים אינטראקטיביים!</p>
  </div>
</body>
</html>
EOF

          cat > manifest.json <<EOF
{
  "name": "ABC English Explorer v3.0",
  "short_name": "ABC Explorer",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#4fc3f7",
  "theme_color": "#4fc3f7",
  "orientation": "portrait-primary",
  "lang": "he",
  "dir": "rtl",
  "icons": [
    {
      "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%234FC3F7' rx='35'/%3E%3Ctext x='96' y='135' font-size='110' text-anchor='middle' fill='white'%3E%F0%9F%A4%96%3C/text%3E%3C/svg%3E",
      "sizes": "192x192",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    },
    {
      "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%234FC3F7' rx='95'/%3E%3Ctext x='256' y='360' font-size='290' text-anchor='middle' fill='white'%3E%F0%9F%A4%96%3C/text%3E%3C/svg%3E",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    }
  ]
}
EOF

          cat > sw.js <<EOF
const CACHE_NAME = 'abc-explorer-v3.0-cache-v1';
const URLS_TO_CACHE = [
  '/',
  '/index.html',
  '/manifest.json'
];
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(URLS_TO_CACHE))
      .then(self.skipWaiting())
  );
});
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
    )).then(() => self.clients.claim())
  );
});
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => response || fetch(event.request))
  );
});
EOF

          cat > lessons/grade1/lesson1.json <<EOF
{
  "id": "grade1_lesson1",
  "title": "ABC - האותיות הראשונות",
  "grade": 1,
  "lesson": 1,
  "difficulty": "beginner",
  "duration": "15 דקות",
  "objectives": [
    "לזהות את האותיות A, B, C",
    "לבטא נכון את הצלילים",
    "להכיר 3 מילים ראשונות באנגלית"
  ],
  "vocabulary": [
    {"word": "Apple", "hebrew": "תפוח", "pronunciation": "AH-puhl", "image": "🍎"},
    {"word": "Ball", "hebrew": "כדור", "pronunciation": "BAWL", "image": "⚽"},
    {"word": "Cat", "hebrew": "חתול", "pronunciation": "KAT", "image": "🐱"}
  ],
  "activities": [
    {
      "type": "letter_recognition",
      "title": "זיהוי אותיות",
      "instruction": "לחצו על האות הנכונה",
      "questions": [
        {"question": "איזו אות מתחילה Apple?", "options": ["A", "B", "C"], "correct": "A"},
        {"question": "איזו אות מתחילה Ball?", "options": ["A", "B", "C"], "correct": "B"},
        {"question": "איזו אות מתחילה Cat?", "options": ["A", "B", "C"], "correct": "C"}
      ]
    }
  ],
  "games": [
    {
      "type": "memory_game",
      "title": "משחק זיכרון ABC",
      "description": "מצאו את הזוגות: מילה ותמונה",
      "cards": [
        {"type": "word", "content": "Apple"},
        {"type": "image", "content": "🍎"},
        {"type": "word", "content": "Ball"},
        {"type": "image", "content": "⚽"},
        {"type": "word", "content": "Cat"},
        {"type": "image", "content": "🐱"}
      ]
    }
  ]
}
EOF

      - name: Commit all files and push to main
        run: |
          git config user.email "abc-explorer@now.com"
          git config user.name "ABC Explorer Bot"
          git add .
          git commit -m "🚀 Complete rebuild with lessons, PWA, design"
          git push

      - name: Setup Pages configuration
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Success message
        run: |
          echo "🎉 ABC English Explorer v3.0 deployed!"
          echo "🌐 https://efroniprojects-debug.github.io/English-Starter/"
