name:  ABC English Explorer - Full Rebuild

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean repository completely
        run: |
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          rm -rf assets lessons css js components || true

      - name: Build site and lessons content
        run: |
          mkdir -p assets/images assets/icons assets/sounds lessons/grade1 lessons/grade2 css js components

          cat > index.html <<EOF
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> ABC English Explorer v3.0</title>
<link rel="manifest" href="manifest.json" />
</head>
<body>
  <div style="text-align:center; margin: 4em;">
    <div style="font-size:5em;"></div>
    <h1>ABC English Explorer v3.0</h1>
    <p>专  驻驻专 转 转拽转 注 转 专拽!</p>
  </div>
</body>
</html>
EOF

          cat > manifest.json <<EOF
{
  "name": "ABC English Explorer v3.0",
  "short_name": "ABC Explorer",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#4fc3f7",
  "theme_color": "#4fc3f7",
  "lang": "he",
  "dir": "rtl",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%234FC3F7' rx='35'/%3E%3Ctext x='96' y='135' font-size='110' text-anchor='middle' fill='white'%3E%F0%9F%A4%96%3C/text%3E%3C/svg%3E",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
}
EOF

          cat > sw.js <<EOF
const CACHE_NAME = 'abc-explorer-v3.0-cache-v1';
const URLS_TO_CACHE = [
  '/',
  '/index.html',
  '/manifest.json'
];

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(URLS_TO_CACHE))
      .then(self.skipWaiting())
  );
});

self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
    )).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        return response || fetch(event.request);
      })
  );
});
EOF

          cat > lessons/grade1/lesson1.json <<EOF
{
  "id": "grade1_lesson1",
  "title": "ABC - 转转 专砖转",
  "grade": 1,
  "vocabulary": [
    {"word": "Apple", "hebrew": "转驻"},
    {"word": "Ball", "hebrew": "专"},
    {"word": "Cat", "hebrew": "转"}
  ]
}
EOF

      - name: Commit and push changes
        run: |
          git config user.name "ABC Explorer Bot"
          git config user.email "abc-explorer@now.com"
          git add .
          git commit -m " Full rebuild with initial site & lesson 1"
          git push

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Deployment success message
        run: echo " ABC English Explorer v3.0 deployed. Check https://efroniprojects-debug.github.io/English-Starter/"
